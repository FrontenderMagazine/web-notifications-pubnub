# Работа с уведомлениями и использование PubNub для создания потоков данных в реальном времени

Уведомления — отличный способ показать, что у приложения появилась новая информация,
например, что вы получили сообщение в Твиттере.

Спецификация [W3C Web Notifications API][1] позволяет браузерам тоже создавать 
уведомления: это отличный способ привлечь внимание пользователя, ведь уведомления
показываются даже если страница неактивна — однако надо иметь в виду, что она 
все же должна быть открыта в одной из фоновых вкладок, чтобы создать уведомление.
W3C не оговаривает, как уведомления должны выглядеть, так что Опера решила 
использовать нативные уведомления, чтобы браузер казался полностью интегрированным 
в операционную систему.

![Скриншот][Пример уведомления]

Уведомления поддерживаются в Опере начиная с 25 версии. Статья 
«[Уведомления в 25 версии Оперы для разработчиков][3]» содержит базовые
принципы использования их API.

Сегодня я покажу, как использовать уведомления создав многопользовательское
приложение c использованием JavaScript API PubNub для потоковой передачи данных 
в реальном времени.


## Что такое сеть передачи данных PubNub?

[PubNub][4] это защищенная глобальная сеть потоковой передачи данных, которая 
позволяет разработчикам создавать, масштабировать и управлять функционалом
приложений и устройств в интернете вещей в реальном времени. (Признаюсь: 
я работаю в PubNub)

![Схема][Парадигма обмена сообщениями на основе подписки и их публикации]
*Обобщенная парадигма обмена сообщениями на основе подписки и их публикации*


## Что мы напишем

Для этой статьи я разработал альтернативу приложения «Yo», которое позволяет
отправлять друзьям сообщение «Yo». Мы напишем [приложение «Oi»][6].

Начнем!


## Проверим поддерживается ли API

Первым шагом будет проверка поддержки браузером Web Notifications API. Проверка
возможностей браузера это хорошая и, на сегодняшний день, необходимая практика, 
так как ещё [не все браузеры это API поддерживают][7].

Давайте будем просто заканчивать работу приложения, если браузер не поддерживает API, 
так как приложение без уведомлений станет полностью бесполезным. Когда вы создаете 
реальное приложение, естественно, стоит для удобства пользователя обеспечить его 
мягкую деградацию.

    if (!window.Notification) {
      alert('Упс, браузер не поддерживает Web Notifications API!');
    } else {
      // Вперед, используй Web Notification API.
    }
    

## Запрос разрешения

Каждый браузер, поддерживающий уведомления, имеет встроенный механизм запроса 
разрешения использования Web Notification API страницей, чтобы пользователь мог 
контролировать, сможет ли она отправлять ему уведомления. Когда страница загружается 
в первый раз, пользователь получает запрос разрешения использования API страницей. 
После того, как пользователь дает такое разрешение, страница может отправлять ему 
уведомления, в противном случае (пользователь не дал разрешение) — нет.

![Скриншот][Пример того, как выглядит запрос разрешения отправки уведомлений]

    Notification.requestPermission(function() {
      if (Notification.permission === 'granted') {
        // Теперь страница может отправлять пользователю уведомления!
      }
    });
    
Попробуйте и все сами увидите. Всегда можно сбросить настройки разрешений, 
открыв opera://settings, выбрав раздел Websites в левой колонке и проскролив
вниз до раздела уведомлений.

![Скринкаст][Сброс настроек уведомлений]


## Соединяем пользователей используя потоки данных PubNub

После того, как пользователь дал свое разрешение, он должен ввести свое имя,
чтобы начать работу со страничкой.

    <input type="text" placeholder="Наберите имя, чтобы начать работу" autofocus>
    
Когда пользователь вводит имя и нажимает кнопку ввода (мы будем отлавливать 
событие `keyup` с кодом клавиши `keyCode === 13`), отправляем имя в поток PubNub, 
чтобы зарегистрировать пользователя.

    document.querySelector('[type="text"]').addEventListener('keyup', function(event) {
      if (event.keyCode !== 13) return;
      if (!input.value) return;
      username = input.value;
      // Соединяемся с PubNub и регистрируем пользователя …
    });


## Инициализируем PubNub используя реквизиты пользователя
    
Это потребует ввода вашего собственного ключа для PubNub API, так что придется 
[создать бесплатную учетную запись][10]. Кнопки опубликовать/подписаться 
находятся в [админ-панели разработчика][11].

Затем, добавьте библиотеку PubNub в HTML.

    <script src="https://cdn.pubnub.com/pubnub.min.js"></script>
    
Теперь, давайте инициализируем клиентское API PubNub с именем пользователя 
в качестве uuid (уникального идентификатора). А ещё, давайте создадим канал 
под названием «oi».

    var channel = 'oi';
    var pubnub = PUBNUB.init({
      subscribe_key: 'your_sub_key',
      publish_key: 'your_pub_key',
      uuid: username
    });
    
## Заполняем список пользователей с помощью API определяющего их присутствие

Теперь можно подписаться на канал сети PubNub, что бы создать TCP сокет и начать
принимать сообщения.

Кроме того, PubNub обеспечивает «определение присутствия», которое позволит 
проверить присутствует ли пользователь, например, когда он переходит в онлайн 
или оффлайн. Это полезно для того, чтобы поддерживать список пользователей,
подписанных на канал, в актуальном состоянии.

В этом примере мы обновляем в DOM список пользователей, которым можно послать
«Oi», используя метод `here_now` API PubNub. Он вызывается каждый раз, когда 
пользователь приходит или покидает канал. (Разберемся с API подписки позже).

    var updateList = function() {
      pubnub.here_now({
        channel: channel,
        callback: function(m) {
          // получаем актуальный список пользователей и обновляем DOM
        }
      });
    };

Чтобы упростить статью и сфокусироваться на важном, я упускаю детали процесса 
определения присутствия, но вы всегда можете заглянуть в [исходники][12] и 
разобраться как оно работает!


## Отправка сообщений

Когда пользователь кликает на имя в списке, приложение публикует сообщение. 
Функция `publish()` используется для его отправки всем подписчикам канала.
Можно просто передать в качестве сообщения объект. В этом примере он содержит
только атрибуты `from` и `to`, но может быть любым.

    var list = document.querySelector('.list');
    list.addEventListener('click', function(event) {
      if (!event.target.id) return;
      pubnub.publish({
        channel: channel,
        message: {
          from: username,
          to: event.target.id
        }
      });
    });
    
В качестве сообщения можно передавать объект с любыми данными, которые захотите
туда поместить. Так что можете изменить скрипт так, чтобы вместо отправляемого 
по умолчанию сообщения «Oi!» пользователи могли отправлять любые сообщения.


## Получение сообщений

Когда кто-то отправляет пользователю сообщение, веб приложение будет создавать 
уведомление.

Чтобы максимально упростить пример, вместо того, чтобы получать приватное
p2p соединение между пользователями, давайте передавать сообщение сразу всем.
Однако, уведомление получит только выбранный при его отправке пользователь.

![Схема][Отправка сообщения всем подписчикам]

Чтобы получать сообщения в реальном времени просто вызовите метод `subscribe()` 
PubNub API. Когда сообщение придет выбранному вами пользователю, он увидит 
уведомление.

    pubnub.subscribe({
      channel: channel,
      callback: function(message) {
        if (message.to === username) {
          showNotification(message);
        }
      }
    });
    

## Создание уведомления

Создание уведомлений элементарно: просто вызовите конструктор `Notification`.

    var notification = new Notification(title, options);
    
Аргумент `title` должен быть строкой, `options` может содержать объект,
имеющий следующие свойства:

* `dir` (направление текста, может принимать значение `auto`, `ltr` и `rtl`. 
  Используется с двунаправленным текстом)
* `lang` (язык)
* `body` (дополнительный текст)
* `tag` (используются для управления множеством экземпляров уведомления)
* `icon` (URL иконки)

Давайте допишем функцию `showNotification`. Следующий код показывает уведомление 
и закрывает его через 30 секунд. Если хотите оставить его открытым до тех пор, 
пока пользователь сам его не закроет — просто пропустите последнюю часть.

Тег, присвоенный каждому экземпляру уведомления, используется чтобы контролировать 
количество уведомлений, которые будут отображаться. Например, даже если приложение 
открыто в множестве вкладок с одинаковым именем пользователя вы получите только 
одно уведомление, если у них будет один и тот же тег.

    function showNotification(data) {
      var notification = new Notification('Oi!', {
        body: 'From: ' + data.from,
        tag: channel,
        icon: 'images/oi.png'
      });
      notification.onshow = function() {
        setTimeout(notification.close, 30000);
      };
    }

![Скриншот][Уведомление]

Та-дам! Теперь вы можете доставать случайных людей отправляя им сообщение «Oi!».
Исходный код доступен на [GitHub][15].

Это очень примитивный и, откровенно говоря, довольно дурацкий пример, но
уведомления могут быть действительно полезным инструментом, если использовать 
их с умом.




[1]: http://www.w3.org/TR/notifications/
[3]: https://dev.opera.com/blog/web-notifications-in-opera-developer-25/
[4]: http://www.pubnub.com
[6]: http://pubnub.github.io/oi-web-notifications/
[7]: http://caniuse.com/#feat=notifications
[10]: http://www.google.com/url?q=http%3A%2F%2Fwww.pubnub.com%2Fget-started%2F&sa=D&sntz=1&usg=AFQjCNHpCZe5gALKuYikUrFqQaySKaNdDA
[11]: https://www.google.com/url?q=https%3A%2F%2Fadmin.pubnub.com%2F&sa=D&sntz=1&usg=AFQjCNFSTvUrfox_eUQqqUYfryvoRQKP8Q
[12]: https://www.google.com/url?q=https%3A%2F%2Fgithub.com%2Fpubnub%2Foi-web-notifications%2F&sa=D&sntz=1&usg=AFQjCNHoZZAiZe0tlv-KoObduXXynqcjpA
[15]: https://github.com/pubnub/oi-web-notifications

[Пример уведомления]: img/web-notification-screen.png "Пример уведомления"
[Парадигма обмена сообщениями на основе подписки и их публикации]: img/pubnub-publish-subscribe-paradigms-ru.png "Парадигма обмена сообщениями на основе подписки и их публикации"
[Пример того, как выглядит запрос разрешения отправки уведомлений]: img/web-notification-permission.png "Пример того, как выглядит запрос разрешения отправки уведомлений"
[Сброс настроек уведомлений]: img/web-notification-permission-preference.gif "Сброс настроек уведомлений"
[Отправка сообщения всем подписчикам]: img/publish-subscribe-oi-ru.png "Отправка сообщения всем подписчикам"
[Уведомление]: img/web-notification.png "Уведомление"
